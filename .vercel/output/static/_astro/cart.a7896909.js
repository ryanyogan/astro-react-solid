let s=[],T=(e,u)=>{let t=[],n={get(){return n.lc||n.listen(()=>{})(),n.value},l:u||0,lc:0,listen(i,f){return n.lc=t.push(i,f||n.l)/2,()=>{let l=t.indexOf(i);~l&&(t.splice(l,2),n.lc--,n.lc||n.off())}},notify(i){let f=!s.length;for(let l=0;l<t.length;l+=2)s.push(t[l],n.value,i,t[l+1]);if(f){for(let l=0;l<s.length;l+=4){let a=!1;for(let d=l+7;d<s.length;d+=4)if(s[d]<s[l+3]){a=!0;break}a?s.push(s[l],s[l+1],s[l+2],s[l+3]):s[l](s[l+1],s[l+2])}s.length=0}},off(){},set(i){n.value!==i&&(n.value=i,n.notify())},subscribe(i,f){let l=n.listen(i,f);return i(n.value),l},value:e};return n};let v=(e,u,t,n)=>(e.events=e.events||{},e.events[t+10]||(e.events[t+10]=n(i=>{e.events[t].reduceRight((f,l)=>(l(f),f),{shared:{},...i})})),e.events[t]=e.events[t]||[],e.events[t].push(u),()=>{let i=e.events[t],f=i.indexOf(u);i.splice(f,1),i.length||(delete e.events[t],e.events[t+10](),delete e.events[t+10])}),c=1e3,N=(e,u)=>v(e,n=>{let i=u(n);i&&e.events[6].push(i)},5,n=>{let i=e.listen;e.listen=(...l)=>(!e.lc&&!e.active&&(e.active=!0,n()),i(...l));let f=e.off;return e.events[6]=[],e.off=()=>{f(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let l of e.events[6])l();e.events[6]=[]}},c)},()=>{e.listen=i,e.off=f}}),U=(e,u)=>{Array.isArray(e)||(e=[e]);let t,n=()=>{let f=e.map(l=>l.get());(t===void 0||f.some((l,a)=>l!==t[a]))&&(t=f,i.set(u(...f)))},i=T(void 0,Math.max(...e.map(f=>f.l))+1);return N(i,()=>{let f=e.map(l=>l.listen(n,i.l));return n(),()=>{for(let l of f)l()}}),i},O=(e={})=>{let u=T(e);return u.setKey=function(t,n){typeof n>"u"?t in u.value&&(u.value={...u.value},delete u.value[t],u.notify(t)):u.value[t]!==n&&(u.value={...u.value,[t]:n},u.notify(t))},u};const r=O({});function o(e){const u=r.get()[e.id],t=u?u.quantity:0;r.setKey(e.id,{item:e,quantity:t+1})}function p(e){r.setKey(e,void 0)}const h=U(r,e=>{let u=0;return Object.values(e).forEach(t=>{t&&(u+=t.quantity*t.item.price)}),u});export{r as $,o as a,p as r,h as s};
